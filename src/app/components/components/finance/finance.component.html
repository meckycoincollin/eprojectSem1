
<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 mt-5">
        <h3>Finance & Installments</h3>
        <span class="breadcrumb"><a [routerLink]="['/']">Home</a> / <b class="text-danger ">Finance</b> </span>
      </div>
    </div>
  </div>
</div>


<div class="finance container">
  <!-- SELECTORS -->
  <section class="selectors card shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Brand</label>
          <select class="form-select" [(ngModel)]="selectedBrand" (change)="onBrandChange(selectedBrand)">
            <option *ngFor="let b of brands" [ngValue]="b">{{ b }}</option>
          </select>
        </div>

        <div class="col-md-5">
          <label class="form-label">Model</label>
          <select class="form-select"
                  [ngModel]="selectedModel?.name"
                  (ngModelChange)="onModelChange($event)">
            <option *ngFor="let m of brandModels" [ngValue]="m.name">{{ m.name }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label d-block">Vehicle Price</label>
          <div class="price-pill">
            {{ selectedModel?.price | currency:'USD':'symbol':'1.0-0' }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLANS -->
  <section class="plans">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="section-title">Available Finance Plans</h3>
    </div>

    <div class="row g-3">
      <div class="col-sm-6 col-lg-4" *ngFor="let p of financePlans">
        <div class="plan card h-100 shadow-sm"
             [class.is-active]="selectedPlanPartner === p.partner">
          <div class="card-body">
            <div class="plan__head">
              <h5 class="plan__title">{{ p.partner }}</h5>
              <span class="badge bg-dark">{{ p.apr }}% APR</span>
            </div>

            <ul class="plan__meta">
              <li><strong>Min. down:</strong> {{ p.minDownPercent }}%</li>
              <li>
                <strong>Terms:</strong>
                <ng-container *ngFor="let t of p.terms; let i = index">
                  <!-- Quan trọng: type="button" để không submit form -->
                  <button
                    type="button"
                    class="term-chip"
                    [class.active]="selectedPlanPartner === p.partner && selectedTerm === t"
                    (click)="selectTerm(p, t)">
                    {{ t }}
                  </button>
                  <span *ngIf="i < p.terms.length - 1">,</span>
                </ng-container>
              </li>
              <li *ngIf="p.processingFee">
                <strong>Processing fee:</strong> {{ p.processingFee | currency:'USD' }}
              </li>
            </ul>

            <p class="plan__note">{{ p.notes }}</p>

            <button type="button" class="btn btn-outline-dark w-100" (click)="selectPlan(p)">
              Use this plan
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CALCULATOR -->
  <section class="calculator card shadow-sm">
    <div class="card-body">
      <h3 class="section-title">Installment Calculator</h3>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Vehicle Price</label>
          <input type="number" min="0" class="form-control"
                 [(ngModel)]="form.price" (input)="calculate()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Down Payment (%)</label>
          <input type="number" min="0" max="90" class="form-control"
                 [(ngModel)]="form.downPercent" (input)="calculate()">
        </div>
        <div class="col-md-3">
          <label class="form-label">APR (% / year)</label>
          <input type="number" min="0" step="0.01" class="form-control"
                 [(ngModel)]="form.apr" (input)="calculate()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Term (months)</label>
          <input type="number" min="1" class="form-control"
                 [(ngModel)]="form.termMonths" (input)="calculate()">
        </div>
      </div>

      <div class="results row g-3 mt-3" *ngIf="results">
        <div class="col-sm-6 col-lg-3">
          <div class="kpi">
            <div class="kpi__label">Down Payment</div>
            <div class="kpi__value">{{ results.downPayment | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="kpi">
            <div class="kpi__label">Loan Principal</div>
            <div class="kpi__value">{{ results.principal | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="kpi">
            <div class="kpi__label">Monthly Payment</div>
            <div class="kpi__value">{{ results.monthlyPayment | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="kpi">
            <div class="kpi__label">Total Interest</div>
            <div class="kpi__value">{{ results.totalInterest | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>
        </div>
      </div>

      <p class="total mt-2" *ngIf="results">
        Total over <strong>{{ form.termMonths }}</strong> months:
        <strong>{{ results.totalPayment | currency:'USD':'symbol':'1.0-0' }}</strong>
      </p>
    </div>
  </section>
</div>
